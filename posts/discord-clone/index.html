<!doctype html><html lang=en dir=auto><head><link href='https://fonts.googleapis.com/css?family=DM Mono' rel=stylesheet><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Discord Clone | MaZiYo's Blog</title><meta name=keywords content><meta name=description content="Todos 问题 如何实现一个router 各个数据模型之间的关系？ 如何进行form验证？ hydration failed initial UI doesn&rsquo;t match what was rendered on the server 利用use-hook-form自定义form表单 如何使用zod来限定数据类型为特定枚举类型或自定义判断 禁用input focus的光标框 如何使用prisma创建关联对象 prisma Disambiguating relations 创建一个动态路由 Next image图片比例不一致 如何条件查询在prisma里面 重置数据库 路由跳转问题 next 国际化 next router速度太慢了 删除server遇到问题 为什么使用useEffect进行事件监听初始化要使用function updater ？ 如何获取在组件中获取当前动态route的params 如何在tailwind中封装一个class，因为每次hover都要反复重复写一次动画，太低效了 每次打开editModal的时候form数据初始化为选中对象的当前数据 如何在nextjs中使用socket.io shadcn-popover溢出到视图外面去了 在输入框中按回车同时打开了附件栏 next i18n 插值翻译 prisma 分页查询 (Cursor-based Pagination) prisma 如何实现hasNextPage? tanstack-query是啥? date-fns如何国际化 nextImage 加载不出来 如何使用react-query配合socket更新已请求的缓存数据 如何使用ref，并且将在type里面定义ref属性 如何在ts里写一个throttle nextjs url query参数 部署问题 目标:实现一个discord-clone，同时学习Next.js React Tailwind
部署地址：https://maziyo-discord.duckdns.org"><meta name=author content="MaZiYo"><link rel=canonical href=https://dmaziyo.github.io/posts/discord-clone/><link crossorigin=anonymous href=/assets/css/stylesheet.6353cf7ec490ca6732824f3e44fd6eb344348f8e19e4f0d966772561c257630c.css integrity="sha256-Y1PPfsSQymcygk8+RP1us0Q0j44Z5PDZZnclYcJXYww=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://dmaziyo.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://dmaziyo.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://dmaziyo.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://dmaziyo.github.io/apple-touch-icon.png><link rel=mask-icon href=https://dmaziyo.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Discord Clone"><meta property="og:description" content="Todos 问题 如何实现一个router 各个数据模型之间的关系？ 如何进行form验证？ hydration failed initial UI doesn&rsquo;t match what was rendered on the server 利用use-hook-form自定义form表单 如何使用zod来限定数据类型为特定枚举类型或自定义判断 禁用input focus的光标框 如何使用prisma创建关联对象 prisma Disambiguating relations 创建一个动态路由 Next image图片比例不一致 如何条件查询在prisma里面 重置数据库 路由跳转问题 next 国际化 next router速度太慢了 删除server遇到问题 为什么使用useEffect进行事件监听初始化要使用function updater ？ 如何获取在组件中获取当前动态route的params 如何在tailwind中封装一个class，因为每次hover都要反复重复写一次动画，太低效了 每次打开editModal的时候form数据初始化为选中对象的当前数据 如何在nextjs中使用socket.io shadcn-popover溢出到视图外面去了 在输入框中按回车同时打开了附件栏 next i18n 插值翻译 prisma 分页查询 (Cursor-based Pagination) prisma 如何实现hasNextPage? tanstack-query是啥? date-fns如何国际化 nextImage 加载不出来 如何使用react-query配合socket更新已请求的缓存数据 如何使用ref，并且将在type里面定义ref属性 如何在ts里写一个throttle nextjs url query参数 部署问题 目标:实现一个discord-clone，同时学习Next.js React Tailwind
部署地址：https://maziyo-discord.duckdns.org"><meta property="og:type" content="article"><meta property="og:url" content="https://dmaziyo.github.io/posts/discord-clone/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-18T08:54:53+08:00"><meta property="article:modified_time" content="2023-11-18T08:54:53+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Discord Clone"><meta name=twitter:description content="Todos 问题 如何实现一个router 各个数据模型之间的关系？ 如何进行form验证？ hydration failed initial UI doesn&rsquo;t match what was rendered on the server 利用use-hook-form自定义form表单 如何使用zod来限定数据类型为特定枚举类型或自定义判断 禁用input focus的光标框 如何使用prisma创建关联对象 prisma Disambiguating relations 创建一个动态路由 Next image图片比例不一致 如何条件查询在prisma里面 重置数据库 路由跳转问题 next 国际化 next router速度太慢了 删除server遇到问题 为什么使用useEffect进行事件监听初始化要使用function updater ？ 如何获取在组件中获取当前动态route的params 如何在tailwind中封装一个class，因为每次hover都要反复重复写一次动画，太低效了 每次打开editModal的时候form数据初始化为选中对象的当前数据 如何在nextjs中使用socket.io shadcn-popover溢出到视图外面去了 在输入框中按回车同时打开了附件栏 next i18n 插值翻译 prisma 分页查询 (Cursor-based Pagination) prisma 如何实现hasNextPage? tanstack-query是啥? date-fns如何国际化 nextImage 加载不出来 如何使用react-query配合socket更新已请求的缓存数据 如何使用ref，并且将在type里面定义ref属性 如何在ts里写一个throttle nextjs url query参数 部署问题 目标:实现一个discord-clone，同时学习Next.js React Tailwind
部署地址：https://maziyo-discord.duckdns.org"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://dmaziyo.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Discord Clone","item":"https://dmaziyo.github.io/posts/discord-clone/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Discord Clone","name":"Discord Clone","description":"Todos 问题 如何实现一个router 各个数据模型之间的关系？ 如何进行form验证？ hydration failed initial UI doesn\u0026rsquo;t match what was rendered on the server 利用use-hook-form自定义form表单 如何使用zod来限定数据类型为特定枚举类型或自定义判断 禁用input focus的光标框 如何使用prisma创建关联对象 prisma Disambiguating relations 创建一个动态路由 Next image图片比例不一致 如何条件查询在prisma里面 重置数据库 路由跳转问题 next 国际化 next router速度太慢了 删除server遇到问题 为什么使用useEffect进行事件监听初始化要使用function updater ？ 如何获取在组件中获取当前动态route的params 如何在tailwind中封装一个class，因为每次hover都要反复重复写一次动画，太低效了 每次打开editModal的时候form数据初始化为选中对象的当前数据 如何在nextjs中使用socket.io shadcn-popover溢出到视图外面去了 在输入框中按回车同时打开了附件栏 next i18n 插值翻译 prisma 分页查询 (Cursor-based Pagination) prisma 如何实现hasNextPage? tanstack-query是啥? date-fns如何国际化 nextImage 加载不出来 如何使用react-query配合socket更新已请求的缓存数据 如何使用ref，并且将在type里面定义ref属性 如何在ts里写一个throttle nextjs url query参数 部署问题 目标:实现一个discord-clone，同时学习Next.js React Tailwind\n部署地址：https://maziyo-discord.duckdns.org","keywords":[],"articleBody":" Todos 问题 如何实现一个router 各个数据模型之间的关系？ 如何进行form验证？ hydration failed initial UI doesn’t match what was rendered on the server 利用use-hook-form自定义form表单 如何使用zod来限定数据类型为特定枚举类型或自定义判断 禁用input focus的光标框 如何使用prisma创建关联对象 prisma Disambiguating relations 创建一个动态路由 Next image图片比例不一致 如何条件查询在prisma里面 重置数据库 路由跳转问题 next 国际化 next router速度太慢了 删除server遇到问题 为什么使用useEffect进行事件监听初始化要使用function updater ？ 如何获取在组件中获取当前动态route的params 如何在tailwind中封装一个class，因为每次hover都要反复重复写一次动画，太低效了 每次打开editModal的时候form数据初始化为选中对象的当前数据 如何在nextjs中使用socket.io shadcn-popover溢出到视图外面去了 在输入框中按回车同时打开了附件栏 next i18n 插值翻译 prisma 分页查询 (Cursor-based Pagination) prisma 如何实现hasNextPage? tanstack-query是啥? date-fns如何国际化 nextImage 加载不出来 如何使用react-query配合socket更新已请求的缓存数据 如何使用ref，并且将在type里面定义ref属性 如何在ts里写一个throttle nextjs url query参数 部署问题 目标:实现一个discord-clone，同时学习Next.js React Tailwind\n部署地址：https://maziyo-discord.duckdns.org\n测试账号：test1@qq.com abc123456\n参考视频:https://www.youtube.com/watch?v=ZbX4Ok9YX94\u0026t=39862s\nTodos 初始化next项目,安装依赖tailwind，ts，shadcn-ui 初始化shadcn-ui配置项 三方登录验证功能 (使用clerk) dark mode (使用shadcn-ui内置组件) 国际化 创建数据库schema (使用prisma，planetScale作为云存储) 需要构建用户，服务器,频道，频道成员 消息存储 实现第三方登录后创建用户数据/读取用户数据 验证登录成功后通过clerk提供的currentUser获取用户信息 用户信息查询/创建 服务器初始化 静态UI界面 表单验证 图片上传(使用uploadThings) 创建服务器api 服务器页面 serverId动态路由页面 读取serverId找到该server，并且默认路由跳转到general频道 用户侧边栏 layout左右布局配置 添加按钮样式 使用提示框来装饰按钮 服务器图标展示 dark mode 以及用户管理按钮 服务器创建模态框 封装模态框(利用zustand作为状态管理器) 封装provider组件提供所有模态框 服务器侧边栏 侧边栏header(展示服务器名称，并且根据权限提供operations) 邀请成员，服务器设置，管理成员，创建频道下拉框展示 邀请功能 邀请链接展示 复制链接 重新生成 邀请码生成页面 server编辑功能 提供modal 添加api 成员管理 以模态框的形式展示 展示成员人数 按列表展示成员头像,名称，邮箱，身份等信息 提供编辑功能,权限设置，删除成员 当编辑某个成员时，提供Loading动画 提供api接口进行修改成员数据(虽然不会在页面上显示删除自己，但是可能通过api的方式删除本人，所以要写判断) 提供频道创建功能 以模态框的形式展示 可以自定义频道名称(频道名称不能为general)和类型(audio，video，text) 提供api接口创建频道 提供退出server\u0026解散server功能 以模态框的形式展示 提供api接口退出server或者解散server 搜索框 以模态框形式展示，并且能够通过快捷键按出(可以直接使用shadcn提供的command组件) 按照分组形式展示频道类别和成员(在点击频道和成员时进行路由跳转) 频道\u0026成员展示列表 分区栏() 显示分区名称,例如TEXT，AUDIO，Member 根据权限以及分区类型来提供编辑按钮，频道为添加按钮，成员为管理按钮(触发已有的modal) 频道列表展示 展示频道名称，根据频道种类显示不同icon 根据权限提供 编辑按钮\u0026删除按钮 提供删除modal\u0026API 提供编辑modal\u0026API 高亮当前频道 频道页面跳转，注意edit和delete的事件冒泡 成员列表展示 展示成员名称，根据权限显示不同icon 根据权限提供 删除按钮 高亮当前用户 聊天跳转 频道页面 频道header 展示频道名称，icon，展示socket服务器连接状态 配置socket服务器在next后端(socket.io),并且提供context在client端 展示socket服务器连接状态(使用shadcn-badge) 在移动端情况下提供操作按钮,点击可以以drawer/sheet的形式展示侧边栏进行操作 聊天消息展示 欢迎框(当没有消息的时候展示) 根据传入的apiUrl，queryParams参数(conversationId|channelId)来请求对应的消息api,获取消息 提供api获取channelMessages 使用@tanstack/react-query提供的来useInfiniteQuery在聊天框初始化消息,并且使用useSocket来判断是否连接了socket服务器，连接了就配置infiniteQuery不重连，没连接就配置infiniteQuery反复请求获取数据 messageItem(渲染消息内容) 展示发送者头像以及身份(点击后能跳转进行对话) 展示发送时间(使用date-fns格式化) 能够展示附件并打开附件 能够编辑消息内容,但文件除外(发送者为自己时才可修改) 当点击edit图标时，文本变成输入框可以进行修改 按回车可以保存，esc可以取消 提供修改消息的api,并且成功后使用socket广播通知 提供删除功能(管理员和发送者都可以删除) 提供删除图标 点击后，以对话框的形式确认是否删除 提供删除api，并且成功后使用socket广播通知 删除后的消息显示该消息已被删除 socket监听更新消息(监听两种情况,新建，更新) message新建，通过socket发送add事件，让queryClient在缓存page上新加item message更新的时候，通过socket发送update事件，让queryClient更新之前的请求缓存 滚动加载 当滚动到元素顶部的时候，进行判断加载上一页的数据(根据react-query提供的isFetching和hasNextpage来判断) 当无法滚动时，提供手动加载先前消息的按钮(因为有可能新加载的page内容不够撑开viewport) 聊天发送框 静态UI(提供附件选项，输入框，表情按钮) 提供消息发送api,在请求完api后socket服务器通知更新当前频道的人。 实现添加附件 以modal框形式展示,并且提供上传的apiUrl以及query,最终将生成的附件url以类似message的形式发送至api 上传成功后显示附件内容,并且可以取消附件 表情栏实现(利用popover，emoji-mart) 发送完后重新focus到input上 对话页面 conversation setup(在数据库中寻找对话|新建对话) 聊天header展示用户名称和头像(将之前频道页面的header复用) 消息列表展示(组件复用channel的) 提供api请求 消息input 提供api请求(组件复用channel的) 视频功能(使用livekit) 频道能够多人视频 对话一对一视频 在聊天顶部右侧提供视频按钮(通过router切换url来检测videoMode，因为page无法同时使用useEffect和db,无法父传子) 问题 如何实现一个router 在next中通过构建folder，每个folder的根文件为page.tsx，之后在url上输入文件夹名称即可\n在next中使用()关键词命名文件夹可以使得文件夹更有结构性，同时不会有router效果\n| (test) | login | page.tsx //最终在url中localhost:xxxx/login即可 效果等同于 | login | page.tsx 各个数据模型之间的关系？ 用户(Profile):server[] chanel[] member[] 服务器(server):profileId chanel[] member[] 频道(Chanel): serverId profileId channel_message[] 成员(member): serverId profileId channel_message[] direct_message[] conversation[](作为发起方) conversations[](作为接收方) //消息的删除不是真的删除，只是不显示 频道消息(channel_message):memberId channelId 直接消息(direct_message):memberId conversationId 对话(Conversation): conversationInitiatedId conversationReceivedId direct_message[] 如何进行form验证？ 使用zod可以进行数据的验证\nimport {z,ZodError} from 'zod'; //通过链式的方法来定义数据结构和验证规则 const userSchema = z.object({ id:z.string(), username:z.string().min(3), email:z.string().email() }); const userData = { id:'123', username:'jhon_doe', email:'2321@qq.com' } try{ userSchema.parse(userDataA); console.log(\"valid!\") }catch(error){ console.error('error!!!') } hydration failed initial UI doesn’t match what was rendered on the server 解决方案:等元素绑定之后再返回渲染的元素 const [isMount, setIsMount] = useState(false); useEffect(() =\u003e { setIsMount(true); }, []); 利用use-hook-form自定义form表单 //https://react-hook-form.com/docs/usecontroller/controller //https://ui.shadcn.com/docs/components/form // controller提供了 \u003cform onSubmit={handleSubmit((data) =\u003e console.log(data))}\u003e \u003cController control={control} name=\"ReactDatepicker\" render={({ field: { onChange, onBlur, value, ref } }) =\u003e ( \u003cReactDatePicker // 提供了onChange，onBlur，value，ref来修改form的值 onChange={onChange} // send value to hook form onBlur={onBlur} // notify when input is touched/blur selected={value} /\u003e )} /\u003e \u003cinput type=\"submit\" /\u003e \u003c/form\u003e 如何使用zod来限定数据类型为特定枚举类型或自定义判断 // 使用refine可以自定义 const myString = z.string().refine((val) =\u003e val.length \u003c= 255, { message: \"String can't be more than 255 characters\", }); // 使用nativeEnum可以检测枚举类型 enum Fruits { Apple = \"apple\", Banana = \"banana\", Cantaloupe, // you can mix numerical and string enums } const FruitEnum = z.nativeEnum(Fruits); type FruitEnum = z.infer\u003ctypeof FruitEnum\u003e; // Fruits FruitEnum.parse(Fruits.Apple); // passes FruitEnum.parse(Fruits.Cantaloupe); // passes FruitEnum.parse(\"apple\"); // passes FruitEnum.parse(\"banana\"); // passes FruitEnum.parse(0); // passes FruitEnum.parse(\"Cantaloupe\"); // fails 禁用input focus的光标框 https://github.com/shadcn-ui/ui/issues/769 https://romansorin.com/blog/disabling-the-tailwind-input-ring className=\"focus:ring-0 focus:ring-offset-0 outline-none\" className=\"focus:ring-transparent\" 本来想尝试custom class，但是发现始终失效，于是就直接在input组件内部添加上述两种都行 如何使用prisma创建关联对象 使用create关键字：https://www.prisma.io/docs/concepts/components/prisma-schema/relations#create-a-record-and-nested-records model User { id String @id @default(auto()) @map(\"_id\") @db.ObjectId posts Post[] } model Post { id String @id @default(auto()) @map(\"_id\") @db.ObjectId author User @relation(fields: [authorId], references: [id]) authorId String @db.ObjectId // relation scalar field (used in the `@relation` attribute above) } const userAndPosts = await prisma.user.create({ data: { posts: { create: [ { title: 'Prisma Day 2020' }, // Populates authorId with user's id { title: 'How to write a Prisma schema' }, // Populates authorId with user's id ], }, }, }) prisma Disambiguating relations 在Prisma中，@relation属性的name参数用于区分同一模型之间的多个关系。当你在同一对模型之间定义两个关系时，你需要添加name参数来消除歧义。 例如，考虑以下模型： model User { id Int @id @default(autoincrement()) name String? writtenPosts Post[] pinnedPost Post? } model Post { id Int @id @default(autoincrement()) title String? author User @relation(fields: [authorId], references: [id]) authorId Int pinnedBy User? @relation(fields: [pinnedById], references: [id]) pinnedById Int? } 在这种情况下，关系是模糊的，有四种不同的方式来解释它们： User.writtenPosts ↔ Post.author + Post.authorId User.writtenPosts ↔ Post.pinnedBy + Post.pinnedById User.pinnedPost ↔ Post.author + Post.authorId User.pinnedPost ↔ Post.pinnedBy + Post.pinnedById 为了消除这些关系的歧义，你需要使用@relation属性并提供name参数。你可以设置任何name（除了空字符串\"\"），但它必须在关系的两边都是相同的： model User { id Int @id @default(autoincrement()) name String? writtenPosts Post[] @relation(\"WrittenPosts\") pinnedPost Post? @relation(\"PinnedPost\") } model Post { id Int @id @default(autoincrement()) title String? author User @relation(\"WrittenPosts\", fields: [authorId], references: [id]) authorId Int pinnedBy User? @relation(\"PinnedPost\", fields: [pinnedById], references: [id]) pinnedById Int? @unique } 在这个例子中，我们使用name参数（\"WrittenPosts\"和\"PinnedPost\"）来明确指定User和Post之间的两个不同关系。 更多关于@relation属性的信息，你可以参考Prisma的官方文档：https://www.prisma.io/docs/orm/prisma-schema/data-model/relations#disambiguating-relations 创建一个动态路由 https://nextjs.org/docs/app/building-your-application/routing/dynamic-routes // app/blog/[slug]/page.tsx 通过[]实现动态路由 Next image图片比例不一致 https://tailwindcss.com/docs/content-configuration#dynamic-class-names 因为我写法有问题,tailwind 不兼容 如何条件查询在prisma里面 //使用or运算符 const server = await db.server.update({ where: { id: serverId, members: { some: { profileId: profile.id, //方法1 OR: [{ type: 'ADMIN' }, { type: 'MODERATOR' }] // 方法2,用in role: { in: [MemberRole.ADMIN, MemberRole.MODERATOR], }, } } }, data: { inviteCode: uuidV4() } }) 重置数据库 npx prisma db push --force-reset 路由跳转问题 使用redirect不起作用，遇到error， https://stackoverflow.com/questions/76191324/next-13-4-error-next-redirect-in-api-routes At the moment, the workaround I found is to not use: import { redirect } from 'next/navigation'; But to use instead: import { useRouter } from 'next/navigation' const router = useRouter() router.push(\"/\") next 国际化 // 1.使用框架 link:https://juejin.cn/post/7300460850011635766?searchId=2023122514051346A97820CD9573BB4D0F // 搜来搜去发现自己总是在找所谓的\"最佳国际化方法\",我的目标不是最优解，而是解决问题啊！！！ // 2.middleware 出问题了 links:https://www.youtube.com/watch?v=0i4pVrOaoiQ // 3.sign-in和sign-up重定向报错 目前来说只能写死zh/sign-in,这样子太不稳妥了，所以我决定直接使用默认的登录配置了 next router速度太慢了 // sources:https://stackoverflow.com/questions/65146878/nextjs-router-seems-very-slow-compare-to-react-router#:~:text=The%20issue%20arises%20because%20every,operations%20as%20much%20as%20possible. // The issue arises because every time you use router.push, it triggers getInitialProps for the page from scratch. This can be quite expensive in terms of performance, especially if you're doing heavy calculations in your React code. To mitigate this, you might want to consider expensive operations as much as possible import { useRouter } from \"next/router\"; const router = useRouter(); const mypath = `/dashboard/some_path`; router.push(mypath); With: const urlOrPath = `/dashboard/some_path`; window.location.href= urlOrPath; 删除server遇到问题 原因：server与其他数据的外键作了绑定限制 需要在关联函数上添加删除后的动作onDelete将与之有绑定的其他数据也删除 // links:https://github.com/prisma/prisma/discussions/10867 model Post { id Int @id @default(autoincrement()) title String author User @relation(fields: [authorId], references: [id], onDelete: Cascade) authorId Int } model User { id Int @id @default(autoincrement()) posts Post[] } 为什么使用useEffect进行事件监听初始化要使用function updater ？ const [open, setOpen] = useState(false) useEffect(() =\u003e { const down = (e: KeyboardEvent) =\u003e { if (e.key === 'k' \u0026\u0026 (e.metaKey || e.ctrlKey)) { e.preventDefault() // 如果是这样子写的话，无依赖，那么每次执行都会只是取到open的false，因为此时存储的是一个闭包,并且open是一个快照 setOpen(!open) //(X) setOpen((open)=\u003e!open)//这个的话就会放到一个队列中去执行,并且参数是取的上一次的state } } document.addEventListener('keydown', down) return () =\u003e { document.removeEventListener('keydown', down) } }, []) 如何获取在组件中获取当前动态route的params // links:https://nextjs.org/docs/app/api-reference/functions/use-params 如何在tailwind中封装一个class，因为每次hover都要反复重复写一次动画，太低效了 links:https://tailwindcss.com/docs/adding-custom-styles @layer utilities { .hover-animation { @apply hover:bg-zinc-700/10 dark:hover:bg-zinc-700/50 transition cursor-pointer; } } 每次打开editModal的时候form数据初始化为选中对象的当前数据 // 加个isOpened作为监听对象即可 const isOpened = isOpen \u0026\u0026 type === 'editServer' useEffect(() =\u003e { if (server \u0026\u0026 isOpened) { form.setValue('name', server.name) form.setValue('image', server.image) } }, [form, server, isOpened]) 如何在nextjs中使用socket.io /*参考links： https://blog.geogo.in/setting-up-socket-io-with-next-js-13-real-time-communication-in-your-web-application-8c95cf17e0c https://blog.stackademic.com/building-a-real-time-chat-app-with-next-js-socket-io-and-typescript-e60ba40c09c7 实战例子：https://codesandbox.io/p/devbox/nextjs-socketio-chat-piffv?file=%2Fsrc%2Ftypes%2Fnext.ts%3A5%2C39-5%2C54 (原来还可以去这种地方找) */ //1.利用route handler来初始化服务器(目前好像2024年1.21,还不能在app router里面使用server来生成socket，https://github.com/vercel/next.js/discussions/47782,所以采用page和app并用的方法) /* tips:因为pages不能嵌套locale作为动态路径使用api，所以在检验url的时候，应该设为publicRoute Any file inside the folder pages/api is mapped to /api/* and will be treated as an API endpoint instead of a page. links:https://www.answeroverflow.com/m/1163761902179074088 export default authMiddleware({ beforeAuth: req =\u003e { return intlMiddleWare(req) }, publicRoutes: ['/api/uploadthing'], ignoredRoutes: ['/api/socket/(.*)'] }) */ import { NextApiResponseServerIO } from '@/type' import type { NextApiRequest, NextApiResponse } from 'next' import { Server as ServerIO } from 'socket.io' export const config = { api: { bodyParser: false } } export default async function SocketHandler(req: NextApiRequest, res: NextApiResponseServerIO) { // 初始化socket server if (!res.socket.server.io) { const httpServer = res.socket.server as any console.log('[ Socket Server initializing ] ') const io = new ServerIO(httpServer, { path: '/api/socketio' }) res.socket.server.io = io } res.end() } //2.写一个provider将socket-client在客户端全局提供 // 参考links:https://medium.com/@steveleung9527/react-contextapi-socket-io-setup-typescript-174acda1164 'use client' import React, { createContext, useContext, useEffect, useState } from 'react' import { io, Socket } from 'socket.io-client' interface SocketContextState { socket: Socket | null isConnected: boolean } export const SocketContext = createContext\u003cSocketContextState\u003e({} as SocketContextState) const SocketProvider = ({ children }: { children: React.ReactNode }) =\u003e { const [socket, setSocket] = useState\u003cSocket | null\u003e(null) const [isConnected, setIsConnected] = useState(false) useEffect(() =\u003e { const socket = io(process.env.NEXT_PUBLIC_SITE!, { path: '/api/socketio' }) socket.on('connect', () =\u003e { console.log('[SOCKET CONNECTED] \u003e', socket.id) setIsConnected(true) setSocket(socket) }) if (socket) { return () =\u003e { socket.disconnect() } } }, []) return \u003cSocketContext.Provider value={{ socket, isConnected }}\u003e{children}\u003c/SocketContext.Provider\u003e } export default SocketProvider shadcn-popover溢出到视图外面去了 // issues:https://github.com/radix-ui/primitives/issues/557 // avoidCollisions,collisionBoundary,collisionPadding好像是跟这几个属性相关，但我不是很想看。。。 // 目前只能调整一下方向来展示 \u003cPopoverContent side='left' className=\"p-0\"\u003e \u003cPicker data={data} onEmojiSelect={onChange} /\u003e \u003c/PopoverContent\u003e 在输入框中按回车同时打开了附件栏 // 因为form中的button在类型没设置的情况下按下回车后会自动触发onSubmit,然后触发按钮的onClick，解决方法就是type设置为button \u003cButton type=\"button\" onClick={() =\u003e { onOpen('fileAttachment', { apiUrl, query }) }} variant=\"ghost\" size=\"icon\" className=\"p-1 w-7 h-7 border-transparent rounded-full text-sm bg-zinc-500 hover:bg-zinc-600 dark:hover:bg-zinc-200 hover:text-white dark:bg-zinc-400 text-white dark:text-[#313338]\" \u003e next i18n 插值翻译 links:https://www.i18next.com/translation-function/interpolation { \"key\": \"{{what}} is {{how}}\" } i18next.t('key', { what: 'i18next', how: 'great' }); // -\u003e \"i18next is great\" // -\u003e \"I am Jan\" prisma 分页查询 (Cursor-based Pagination) //links:https://www.prisma.io/docs/orm/prisma-client/queries/pagination#cursor-based-pagination const firstQueryResults = await prisma.post.findMany({ take: 4, where: { title: { contains: 'Prisma' } }, orderBy: { id: 'asc' }, }); // Bookmark your location in the result set - in this case, the ID of the last post in the list of 4. const lastPostInResults = firstQueryResults[3]; // Remember: zero-based index! :) const myCursor = lastPostInResults.id; // Example: 29 const secondQueryResults = await prisma.post.findMany({ take: 4, skip: 1, // Skip the cursor cursor: { id: myCursor }, where: { title: { contains: 'Prisma' } }, orderBy: { id: 'asc' }, }); const lastPostInResults = secondQueryResults[3]; // Remember: zero-based index! :) const myCursor = lastPostInResults.id; // Example: 52 prisma 如何实现hasNextPage? // Fetch PAGE_BATCH + 1 messages messages = await db.channelMessage.findMany({ take: PAGE_BATCH + 1, where: { channelId }, include: { member: { include: { Profile: true } } }, orderBy: { createdAt: 'desc' } }) let hasNextPage = false; let nextCursor = null; // If we got an extra message, there's a next page if (messages.length === PAGE_BATCH + 1) { hasNextPage = true; messages.pop(); // Remove the extra message } // If there's a next page, set the nextCursor to the ID of the last message if (hasNextPage) { nextCursor = messages[messages.length - 1].id; } // 土方法 tanstack-query是啥? // 1.一种封装好的请求工具，将异步请求函数放进去执行，会对该请求添加一个key用于缓存，当再次请求带有相同key的函数时，会直接拿现有的缓存， // 2.并且调用请求后会返回当前状态等一系列数据信息(实时更新), // 3.可以实现条件执行，当满足某种条件后再去fetch data const { status: statusUser, data:user } = useQuery( enabled:post?.userId!=null, queryKey:[\"users\",post?.userId], queryFn:()=\u003egetUser(post!.userId)) // 4.能够进行修改数据的同时，减少请求的次数 const {status,error,mutate}=useMutation( { mutationFn：createPost, onSuccess：newPost=\u003e{ // 无需再次请求，直接设置好 queryclient.setQueryData([\"posts\",newPost.id],newPost) navigate(/posts/s(newPost.id)) } }) // 5.能够快速进行分页请求以及滚动无限加载 const { fetchNextPage, fetchPreviousPage, hasNextPage, hasPreviousPage, isFetchingNextPage, isFetchingPreviousPage, ...result } = useInfiniteQuery({ queryKey, queryFn: ({ pageParam }) =\u003e fetchPage(pageParam), initialPageParam: 1, ...options, getNextPageParam: (lastPage, allPages, lastPageParam, allPageParams) =\u003e lastPage.nextCursor, getPreviousPageParam: (firstPage, allPages, firstPageParam, allPageParams) =\u003e firstPage.prevCursor, }) //https://tanstack.com/query/latest/docs/framework/react/examples/load-more-infinite-scroll date-fns如何国际化 import { format } from 'date-fns' import { zhCN, enUS } from 'date-fns/locale' import { getI18n } from 'react-i18next' const locales = { zh: zhCN, en: enUS } export default function dateFormat(date: Date, formatStr = 'PPpp') { const { language } = getI18n() return format(date, formatStr, { locale: locales[language as 'zh' | 'en'] }) } //参考格式:https://date-fns.org/v3.3.1/docs/format nextImage 加载不出来 links:https://cloud.tencent.com/developer/ask/sof/106766303 又好了，我也不知道啥原因，目前无法复现。 如何使用react-query配合socket更新已请求的缓存数据 links:https://tkdodo.eu/blog/using-web-sockets-with-react-query queryClient.setQueryData([queryKey], (oldData: any) =\u003e { // 需要返回一个immutable的对象 const newPages = oldData.pages.slice() // Immutability , Updates via setQueryData must be performed in an immutable way. DO NOT attempt to write directly to the cache by mutating oldData or data that you retrieved via getQueryData in place. newPages[0] = { ...newPages[0], items: [message, ...newPages[0].items] } const newData = { ...oldData, pages: newPages } return newData }) 如何使用ref，并且将在type里面定义ref属性 links:https://stackoverflow.com/questions/33796267/how-to-use-refs-in-react-with-typescript type stepInput= React.RefObject\u003cHTMLInputElement\u003e; 如何在ts里写一个throttle //links:https://vue3js.cn/interview/JavaScript/debounce_throttle.html#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0 export function throttle(fn: Function, delay: number) { let timer: ReturnType\u003ctypeof setTimeout\u003e let startTime = Date.now() return function (...args: any) { let curTime = Date.now() let remaining = delay - (curTime - startTime) // 说明超过delay了 if (remaining \u003c= 0) { fn(...args) startTime = Date.now() } else { clearTimeout(timer) timer = setTimeout(() =\u003e { fn(...args) }, remaining) } } } nextjs url query参数 page links:https://nextjs.org/docs/app/api-reference/file-conventions/page#searchparams-optional component links:https://www.codingbeautydev.com/blog/nextjs-get-url-query-params 部署问题 // 阿里云npm i killed 内存不够了，使用虚拟内存 links:https://cloud.tencent.com/developer/article/1750413 // node 内存崩溃 links:https://www.jianshu.com/p/a0a0b57a375c // https 才能访问camera 参考视频:https://www.youtube.com/watch?v=qlcVx-k-02E https://notthebe.ee/blog/easy-ssl-in-homelab-dns01/ ","wordCount":"1755","inLanguage":"en","datePublished":"2023-11-18T08:54:53+08:00","dateModified":"2023-11-18T08:54:53+08:00","author":{"@type":"Person","name":"MaZiYo"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://dmaziyo.github.io/posts/discord-clone/"},"publisher":{"@type":"Organization","name":"MaZiYo's Blog","logo":{"@type":"ImageObject","url":"https://dmaziyo.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://dmaziyo.github.io accesskey=h title="MaZiYo's Blog (Alt + H)">MaZiYo's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://dmaziyo.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://dmaziyo.github.io/posts/ title=Blog><span>Blog</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Discord Clone</h1><div class=post-meta><span title='2023-11-18 08:54:53 +0800 +0800'>November 18, 2023</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;MaZiYo</div></header><div class=post-content><ul><li><a href=#todos>Todos</a></li><li><a href=#%E9%97%AE%E9%A2%98>问题</a><ul><li><a href=#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AArouter>如何实现一个router</a></li><li><a href=#%E5%90%84%E4%B8%AA%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB>各个数据模型之间的关系？</a></li><li><a href=#%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8Cform%E9%AA%8C%E8%AF%81>如何进行form验证？</a></li><li><a href=#hydration-failed-initial-ui-doesnt-match-what-was-rendered-on-the-server>hydration failed initial UI doesn&rsquo;t match what was rendered on the server</a></li><li><a href=#%E5%88%A9%E7%94%A8use-hook-form%E8%87%AA%E5%AE%9A%E4%B9%89form%E8%A1%A8%E5%8D%95>利用use-hook-form自定义form表单</a></li><li><a href=#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8zod%E6%9D%A5%E9%99%90%E5%AE%9A%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B8%BA%E7%89%B9%E5%AE%9A%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B%E6%88%96%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%A4%E6%96%AD>如何使用zod来限定数据类型为特定枚举类型或自定义判断</a></li><li><a href=#%E7%A6%81%E7%94%A8input-focus%E7%9A%84%E5%85%89%E6%A0%87%E6%A1%86>禁用input focus的光标框</a></li><li><a href=#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8prisma%E5%88%9B%E5%BB%BA%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1>如何使用prisma创建关联对象</a></li><li><a href=#prisma-disambiguating-relations>prisma Disambiguating relations</a></li><li><a href=#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1>创建一个动态路由</a></li><li><a href=#next-image%E5%9B%BE%E7%89%87%E6%AF%94%E4%BE%8B%E4%B8%8D%E4%B8%80%E8%87%B4>Next image图片比例不一致</a></li><li><a href=#%E5%A6%82%E4%BD%95%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2%E5%9C%A8prisma%E9%87%8C%E9%9D%A2>如何条件查询在prisma里面</a></li><li><a href=#%E9%87%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E5%BA%93>重置数据库</a></li><li><a href=#%E8%B7%AF%E7%94%B1%E8%B7%B3%E8%BD%AC%E9%97%AE%E9%A2%98>路由跳转问题</a></li><li><a href=#next-%E5%9B%BD%E9%99%85%E5%8C%96>next 国际化</a></li><li><a href=#next-router%E9%80%9F%E5%BA%A6%E5%A4%AA%E6%85%A2%E4%BA%86>next router速度太慢了</a></li><li><a href=#%E5%88%A0%E9%99%A4server%E9%81%87%E5%88%B0%E9%97%AE%E9%A2%98>删除server遇到问题</a></li><li><a href=#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8useeffect%E8%BF%9B%E8%A1%8C%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%E5%88%9D%E5%A7%8B%E5%8C%96%E8%A6%81%E4%BD%BF%E7%94%A8function-updater->为什么使用useEffect进行事件监听初始化要使用function updater ？</a></li><li><a href=#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E5%9C%A8%E7%BB%84%E4%BB%B6%E4%B8%AD%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E5%8A%A8%E6%80%81route%E7%9A%84params>如何获取在组件中获取当前动态route的params</a></li><li><a href=#%E5%A6%82%E4%BD%95%E5%9C%A8tailwind%E4%B8%AD%E5%B0%81%E8%A3%85%E4%B8%80%E4%B8%AAclass%E5%9B%A0%E4%B8%BA%E6%AF%8F%E6%AC%A1hover%E9%83%BD%E8%A6%81%E5%8F%8D%E5%A4%8D%E9%87%8D%E5%A4%8D%E5%86%99%E4%B8%80%E6%AC%A1%E5%8A%A8%E7%94%BB%E5%A4%AA%E4%BD%8E%E6%95%88%E4%BA%86>如何在tailwind中封装一个class，因为每次hover都要反复重复写一次动画，太低效了</a></li><li><a href=#%E6%AF%8F%E6%AC%A1%E6%89%93%E5%BC%80editmodal%E7%9A%84%E6%97%B6%E5%80%99form%E6%95%B0%E6%8D%AE%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%BA%E9%80%89%E4%B8%AD%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%BD%93%E5%89%8D%E6%95%B0%E6%8D%AE>每次打开editModal的时候form数据初始化为选中对象的当前数据</a></li><li><a href=#%E5%A6%82%E4%BD%95%E5%9C%A8nextjs%E4%B8%AD%E4%BD%BF%E7%94%A8socketio>如何在nextjs中使用socket.io</a></li><li><a href=#shadcn-popover%E6%BA%A2%E5%87%BA%E5%88%B0%E8%A7%86%E5%9B%BE%E5%A4%96%E9%9D%A2%E5%8E%BB%E4%BA%86>shadcn-popover溢出到视图外面去了</a></li><li><a href=#%E5%9C%A8%E8%BE%93%E5%85%A5%E6%A1%86%E4%B8%AD%E6%8C%89%E5%9B%9E%E8%BD%A6%E5%90%8C%E6%97%B6%E6%89%93%E5%BC%80%E4%BA%86%E9%99%84%E4%BB%B6%E6%A0%8F>在输入框中按回车同时打开了附件栏</a></li><li><a href=#next-i18n-%E6%8F%92%E5%80%BC%E7%BF%BB%E8%AF%91>next i18n 插值翻译</a></li><li><a href=#prisma-%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2-cursor-based-pagination>prisma 分页查询 (Cursor-based Pagination)</a></li><li><a href=#prisma-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0hasnextpage>prisma 如何实现hasNextPage?</a></li><li><a href=#tanstack-query%E6%98%AF%E5%95%A5>tanstack-query是啥?</a></li><li><a href=#date-fns%E5%A6%82%E4%BD%95%E5%9B%BD%E9%99%85%E5%8C%96>date-fns如何国际化</a></li><li><a href=#nextimage-%E5%8A%A0%E8%BD%BD%E4%B8%8D%E5%87%BA%E6%9D%A5>nextImage 加载不出来</a></li><li><a href=#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8react-query%E9%85%8D%E5%90%88socket%E6%9B%B4%E6%96%B0%E5%B7%B2%E8%AF%B7%E6%B1%82%E7%9A%84%E7%BC%93%E5%AD%98%E6%95%B0%E6%8D%AE>如何使用react-query配合socket更新已请求的缓存数据</a></li><li><a href=#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8ref%E5%B9%B6%E4%B8%94%E5%B0%86%E5%9C%A8type%E9%87%8C%E9%9D%A2%E5%AE%9A%E4%B9%89ref%E5%B1%9E%E6%80%A7>如何使用ref，并且将在type里面定义ref属性</a></li><li><a href=#%E5%A6%82%E4%BD%95%E5%9C%A8ts%E9%87%8C%E5%86%99%E4%B8%80%E4%B8%AAthrottle>如何在ts里写一个throttle</a></li><li><a href=#nextjs--url-query%E5%8F%82%E6%95%B0>nextjs url query参数</a></li><li><a href=#%E9%83%A8%E7%BD%B2%E9%97%AE%E9%A2%98>部署问题</a></li></ul></li></ul><p><strong>目标</strong>:实现一个discord-clone，同时学习Next.js React Tailwind</p><p><strong>部署地址</strong>：https://maziyo-discord.duckdns.org</p><p><strong>测试账号</strong>：test1@qq.com abc123456</p><p><strong>参考视频</strong>:https://www.youtube.com/watch?v=ZbX4Ok9YX94&amp;t=39862s</p><h2 id=todos>Todos<a hidden class=anchor aria-hidden=true href=#todos>#</a></h2><ul><li><input checked disabled type=checkbox> 初始化next项目,安装依赖tailwind，ts，shadcn-ui<ul><li><input checked disabled type=checkbox> 初始化shadcn-ui配置项</li></ul></li><li><input checked disabled type=checkbox> 三方登录验证功能 (使用clerk)</li><li><input checked disabled type=checkbox> dark mode (使用shadcn-ui内置组件)</li><li><input checked disabled type=checkbox> 国际化</li><li><input checked disabled type=checkbox> 创建数据库schema (使用prisma，planetScale作为云存储)<ul><li><input checked disabled type=checkbox> 需要构建用户，服务器,频道，频道成员</li><li><input checked disabled type=checkbox> 消息存储</li></ul></li><li><input checked disabled type=checkbox> 实现第三方登录后创建用户数据/读取用户数据<ul><li><input checked disabled type=checkbox> 验证登录成功后通过clerk提供的currentUser获取用户信息</li><li><input checked disabled type=checkbox> 用户信息查询/创建</li></ul></li><li><input checked disabled type=checkbox> 服务器初始化<ul><li><input checked disabled type=checkbox> 静态UI界面</li><li><input checked disabled type=checkbox> 表单验证</li><li><input checked disabled type=checkbox> 图片上传(使用uploadThings)</li><li><input checked disabled type=checkbox> 创建服务器api</li></ul></li><li><input checked disabled type=checkbox> 服务器页面<ul><li><input checked disabled type=checkbox> serverId动态路由页面<ul><li><input checked disabled type=checkbox> 读取serverId找到该server，并且默认路由跳转到general频道</li></ul></li><li><input checked disabled type=checkbox> 用户侧边栏<ul><li><input checked disabled type=checkbox> layout左右布局配置</li><li><input checked disabled type=checkbox> 添加按钮样式<ul><li><input checked disabled type=checkbox> 使用提示框来装饰按钮</li></ul></li><li><input checked disabled type=checkbox> 服务器图标展示</li><li><input checked disabled type=checkbox> dark mode 以及用户管理按钮</li><li><input checked disabled type=checkbox> 服务器创建模态框<ul><li><input checked disabled type=checkbox> 封装模态框(利用zustand作为状态管理器)</li><li><input checked disabled type=checkbox> 封装provider组件提供所有模态框</li></ul></li></ul></li><li><input checked disabled type=checkbox> 服务器侧边栏<ul><li><input checked disabled type=checkbox> 侧边栏header(展示服务器名称，并且根据权限提供operations)<ul><li><input checked disabled type=checkbox> 邀请成员，服务器设置，管理成员，创建频道下拉框展示</li><li><input checked disabled type=checkbox> 邀请功能<ul><li><input checked disabled type=checkbox> 邀请链接展示</li><li><input checked disabled type=checkbox> 复制链接</li><li><input checked disabled type=checkbox> 重新生成</li><li><input checked disabled type=checkbox> 邀请码生成页面</li></ul></li><li><input checked disabled type=checkbox> server编辑功能<ul><li><input checked disabled type=checkbox> 提供modal</li><li><input checked disabled type=checkbox> 添加api</li></ul></li><li><input checked disabled type=checkbox> 成员管理<ul><li><input checked disabled type=checkbox> 以模态框的形式展示</li><li><input checked disabled type=checkbox> 展示成员人数</li><li><input checked disabled type=checkbox> 按列表展示成员头像,名称，邮箱，身份等信息</li><li><input checked disabled type=checkbox> 提供编辑功能,权限设置，删除成员</li><li><input checked disabled type=checkbox> 当编辑某个成员时，提供Loading动画</li><li><input checked disabled type=checkbox> 提供api接口进行修改成员数据(虽然不会在页面上显示删除自己，但是可能通过api的方式删除本人，所以要写判断)</li></ul></li><li><input checked disabled type=checkbox> 提供频道创建功能<ul><li><input checked disabled type=checkbox> 以模态框的形式展示</li><li><input checked disabled type=checkbox> 可以自定义频道名称(频道名称不能为general)和类型(audio，video，text)</li><li><input checked disabled type=checkbox> 提供api接口创建频道</li></ul></li><li><input checked disabled type=checkbox> 提供退出server&解散server功能<ul><li><input checked disabled type=checkbox> 以模态框的形式展示</li><li><input checked disabled type=checkbox> 提供api接口退出server或者解散server</li></ul></li></ul></li><li><input checked disabled type=checkbox> 搜索框<ul><li><input checked disabled type=checkbox> 以模态框形式展示，并且能够通过快捷键按出(可以直接使用shadcn提供的command组件)</li><li><input checked disabled type=checkbox> 按照分组形式展示频道类别和成员(在点击频道和成员时进行路由跳转)</li></ul></li><li><input checked disabled type=checkbox> 频道&成员展示列表<ul><li><input checked disabled type=checkbox> 分区栏()<ul><li><input checked disabled type=checkbox> 显示分区名称,例如TEXT，AUDIO，Member</li><li><input checked disabled type=checkbox> 根据权限以及分区类型来提供编辑按钮，频道为添加按钮，成员为管理按钮(触发已有的modal)</li></ul></li><li><input checked disabled type=checkbox> 频道列表展示<ul><li><input checked disabled type=checkbox> 展示频道名称，根据频道种类显示不同icon</li><li><input checked disabled type=checkbox> 根据权限提供 编辑按钮&删除按钮<ul><li><input checked disabled type=checkbox> 提供删除modal&amp;API</li><li><input checked disabled type=checkbox> 提供编辑modal&amp;API</li></ul></li><li><input checked disabled type=checkbox> 高亮当前频道</li><li><input checked disabled type=checkbox> 频道页面跳转，注意edit和delete的事件冒泡</li></ul></li><li><input checked disabled type=checkbox> 成员列表展示<ul><li><input checked disabled type=checkbox> 展示成员名称，根据权限显示不同icon</li><li><input checked disabled type=checkbox> 根据权限提供 删除按钮</li><li><input checked disabled type=checkbox> 高亮当前用户</li><li><input checked disabled type=checkbox> 聊天跳转</li></ul></li></ul></li></ul></li></ul></li><li><input checked disabled type=checkbox> 频道页面<ul><li><input checked disabled type=checkbox> 频道header<ul><li><input checked disabled type=checkbox> 展示频道名称，icon，展示socket服务器连接状态</li><li><input checked disabled type=checkbox> 配置socket服务器在next后端(socket.io),并且提供context在client端</li><li><input checked disabled type=checkbox> 展示socket服务器连接状态(使用shadcn-badge)</li><li><input checked disabled type=checkbox> 在移动端情况下提供操作按钮,点击可以以drawer/sheet的形式展示侧边栏进行操作</li></ul></li><li><input checked disabled type=checkbox> 聊天消息展示<ul><li><input checked disabled type=checkbox> 欢迎框(当没有消息的时候展示)</li><li><input checked disabled type=checkbox> 根据传入的apiUrl，queryParams参数(conversationId|channelId)来请求对应的消息api,获取消息<ul><li><input checked disabled type=checkbox> 提供api获取channelMessages</li><li><input checked disabled type=checkbox> 使用@tanstack/react-query提供的来useInfiniteQuery在聊天框初始化消息,并且使用useSocket来判断是否连接了socket服务器，连接了就配置infiniteQuery不重连，没连接就配置infiniteQuery反复请求获取数据</li></ul></li><li><input checked disabled type=checkbox> messageItem(渲染消息内容)<ul><li><input checked disabled type=checkbox> 展示发送者头像以及身份(点击后能跳转进行对话)</li><li><input checked disabled type=checkbox> 展示发送时间(使用date-fns格式化)</li><li><input checked disabled type=checkbox> 能够展示附件并打开附件</li><li><input checked disabled type=checkbox> 能够编辑消息内容,但文件除外(发送者为自己时才可修改)<ul><li><input checked disabled type=checkbox> 当点击edit图标时，文本变成输入框可以进行修改</li><li><input checked disabled type=checkbox> 按回车可以保存，esc可以取消</li><li><input checked disabled type=checkbox> 提供修改消息的api,并且成功后使用socket广播通知</li></ul></li><li><input checked disabled type=checkbox> 提供删除功能(管理员和发送者都可以删除)<ul><li><input checked disabled type=checkbox> 提供删除图标</li><li><input checked disabled type=checkbox> 点击后，以对话框的形式确认是否删除</li><li><input checked disabled type=checkbox> 提供删除api，并且成功后使用socket广播通知</li><li><input checked disabled type=checkbox> 删除后的消息显示该消息已被删除</li></ul></li></ul></li><li><input checked disabled type=checkbox> socket监听更新消息(监听两种情况,新建，更新)<ul><li><input checked disabled type=checkbox> message新建，通过socket发送add事件，让queryClient在缓存page上新加item</li><li><input checked disabled type=checkbox> message更新的时候，通过socket发送update事件，让queryClient更新之前的请求缓存</li></ul></li><li><input checked disabled type=checkbox> 滚动加载<ul><li><input checked disabled type=checkbox> 当滚动到元素顶部的时候，进行判断加载上一页的数据(根据react-query提供的isFetching和hasNextpage来判断)</li><li><input checked disabled type=checkbox> 当无法滚动时，提供手动加载先前消息的按钮(因为有可能新加载的page内容不够撑开viewport)</li></ul></li></ul></li><li><input checked disabled type=checkbox> 聊天发送框<ul><li><input checked disabled type=checkbox> 静态UI(提供附件选项，输入框，表情按钮)</li><li><input checked disabled type=checkbox> 提供消息发送api,在请求完api后socket服务器通知更新当前频道的人。</li><li><input checked disabled type=checkbox> 实现添加附件<ul><li><input checked disabled type=checkbox> 以modal框形式展示,并且提供上传的apiUrl以及query,最终将生成的附件url以类似message的形式发送至api</li><li><input checked disabled type=checkbox> 上传成功后显示附件内容,并且可以取消附件</li></ul></li><li><input checked disabled type=checkbox> 表情栏实现(利用popover，emoji-mart)</li><li><input checked disabled type=checkbox> 发送完后重新focus到input上</li></ul></li></ul></li><li><input checked disabled type=checkbox> 对话页面<ul><li><input checked disabled type=checkbox> conversation setup(在数据库中寻找对话|新建对话)</li><li><input checked disabled type=checkbox> 聊天header展示用户名称和头像(将之前频道页面的header复用)</li><li><input checked disabled type=checkbox> 消息列表展示(组件复用channel的)<ul><li><input checked disabled type=checkbox> 提供api请求</li></ul></li><li><input checked disabled type=checkbox> 消息input<ul><li><input checked disabled type=checkbox> 提供api请求(组件复用channel的)</li></ul></li></ul></li><li><input checked disabled type=checkbox> 视频功能(使用livekit)<ul><li><input checked disabled type=checkbox> 频道能够多人视频</li><li><input checked disabled type=checkbox> 对话一对一视频<ul><li><input checked disabled type=checkbox> 在聊天顶部右侧提供视频按钮(通过router切换url来检测videoMode，因为page无法同时使用useEffect和db,无法父传子)</li></ul></li></ul></li></ul><h2 id=问题>问题<a hidden class=anchor aria-hidden=true href=#问题>#</a></h2><h4 id=如何实现一个router>如何实现一个router<a hidden class=anchor aria-hidden=true href=#如何实现一个router>#</a></h4><p>在next中通过构建folder，每个folder的根文件为page.tsx，之后在url上输入文件夹名称即可</p><p>在next中使用()关键词命名文件夹可以使得文件夹更有结构性，同时不会有router效果</p><pre tabindex=0><code>| (test)
  | login
    | page.tsx   //最终在url中localhost:xxxx/login即可
效果等同于
| login
    | page.tsx
</code></pre><h4 id=各个数据模型之间的关系>各个数据模型之间的关系？<a hidden class=anchor aria-hidden=true href=#各个数据模型之间的关系>#</a></h4><pre tabindex=0><code>用户(Profile):server[] chanel[] member[]
服务器(server):profileId chanel[] member[]
频道(Chanel): serverId profileId channel_message[]
成员(member): serverId profileId channel_message[] direct_message[]  conversation[](作为发起方) conversations[](作为接收方)
//消息的删除不是真的删除，只是不显示
频道消息(channel_message):memberId channelId
直接消息(direct_message):memberId conversationId
对话(Conversation): conversationInitiatedId conversationReceivedId  direct_message[]
</code></pre><h4 id=如何进行form验证>如何进行form验证？<a hidden class=anchor aria-hidden=true href=#如何进行form验证>#</a></h4><p>使用zod可以进行数据的验证</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> {<span style=color:#a6e22e>z</span>,<span style=color:#a6e22e>ZodError</span>} <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;zod&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//通过链式的方法来定义数据结构和验证规则
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userSchema</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>z</span>.<span style=color:#a6e22e>object</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span><span style=color:#a6e22e>z</span>.<span style=color:#a6e22e>string</span>(),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span><span style=color:#a6e22e>z</span>.<span style=color:#a6e22e>string</span>().<span style=color:#a6e22e>min</span>(<span style=color:#ae81ff>3</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>email</span><span style=color:#f92672>:</span><span style=color:#a6e22e>z</span>.<span style=color:#a6e22e>string</span>().<span style=color:#a6e22e>email</span>()
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userData</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;123&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;jhon_doe&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>email</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;2321@qq.com&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userSchema</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>userDataA</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;valid!&#34;</span>)
</span></span><span style=display:flex><span>}<span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>error</span>){
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;error!!!&#39;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=hydration-failed-initial-ui-doesnt-match-what-was-rendered-on-the-server>hydration failed initial UI doesn&rsquo;t match what was rendered on the server<a hidden class=anchor aria-hidden=true href=#hydration-failed-initial-ui-doesnt-match-what-was-rendered-on-the-server>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>解决方案</span><span style=color:#f92672>:</span><span style=color:#a6e22e>等元素绑定之后再返回渲染的元素</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>isMount</span>, <span style=color:#a6e22e>setIsMount</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>useEffect</span>(() =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>setIsMount</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>  }, []);
</span></span></code></pre></div><h4 id=利用use-hook-form自定义form表单>利用use-hook-form自定义form表单<a hidden class=anchor aria-hidden=true href=#利用use-hook-form自定义form表单>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>//https://react-hook-form.com/docs/usecontroller/controller
</span></span></span><span style=display:flex><span><span style=color:#75715e>//https://ui.shadcn.com/docs/components/form
</span></span></span><span style=display:flex><span><span style=color:#75715e>// controller提供了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>form</span> <span style=color:#a6e22e>onSubmit</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>handleSubmit</span>((<span style=color:#a6e22e>data</span>) =&gt; <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>data</span>))}<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Controller</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>control</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>control</span>}
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ReactDatepicker&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>render</span><span style=color:#f92672>=</span>{({ <span style=color:#a6e22e>field</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>onChange</span>, <span style=color:#a6e22e>onBlur</span>, <span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>ref</span> } }) =&gt; (
</span></span><span style=display:flex><span>          <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>ReactDatePicker</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//   提供了onChange，onBlur，value，ref来修改form的值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>onChange</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>onChange</span>} <span style=color:#75715e>// send value to hook form
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>onBlur</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>onBlur</span>} <span style=color:#75715e>// notify when input is touched/blur
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>selected</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>value</span>}
</span></span><span style=display:flex><span>          <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>        )}
</span></span><span style=display:flex><span>      <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;submit&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/form&gt;</span>
</span></span></code></pre></div><h4 id=如何使用zod来限定数据类型为特定枚举类型或自定义判断>如何使用zod来限定数据类型为特定枚举类型或自定义判断<a hidden class=anchor aria-hidden=true href=#如何使用zod来限定数据类型为特定枚举类型或自定义判断>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// 使用refine可以自定义
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>myString</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>z</span>.<span style=color:#a6e22e>string</span>().<span style=color:#a6e22e>refine</span>((<span style=color:#a6e22e>val</span>) =&gt; <span style=color:#a6e22e>val</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>255</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;String can&#39;t be more than 255 characters&#34;</span>,
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span><span style=color:#75715e>// 使用nativeEnum可以检测枚举类型
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>Fruits</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Apple</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;apple&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Banana</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;banana&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Cantaloupe</span>, <span style=color:#75715e>// you can mix numerical and string enums
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>FruitEnum</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>z</span>.<span style=color:#a6e22e>nativeEnum</span>(<span style=color:#a6e22e>Fruits</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>type</span> <span style=color:#a6e22e>FruitEnum</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>z</span>.<span style=color:#a6e22e>infer</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>FruitEnum</span><span style=color:#f92672>&gt;</span>; <span style=color:#75715e>// Fruits
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>FruitEnum</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>Fruits</span>.<span style=color:#a6e22e>Apple</span>); <span style=color:#75715e>// passes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>FruitEnum</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>Fruits</span>.<span style=color:#a6e22e>Cantaloupe</span>); <span style=color:#75715e>// passes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>FruitEnum</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;apple&#34;</span>); <span style=color:#75715e>// passes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>FruitEnum</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;banana&#34;</span>); <span style=color:#75715e>// passes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>FruitEnum</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#ae81ff>0</span>); <span style=color:#75715e>// passes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>FruitEnum</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;Cantaloupe&#34;</span>); <span style=color:#75715e>// fails
</span></span></span></code></pre></div><h4 id=禁用input-focus的光标框>禁用input focus的光标框<a hidden class=anchor aria-hidden=true href=#禁用input-focus的光标框>#</a></h4><pre tabindex=0><code>https://github.com/shadcn-ui/ui/issues/769
https://romansorin.com/blog/disabling-the-tailwind-input-ring
className=&#34;focus:ring-0 focus:ring-offset-0 outline-none&#34;
className=&#34;focus:ring-transparent&#34;
本来想尝试custom class，但是发现始终失效，于是就直接在input组件内部添加上述两种都行
</code></pre><h4 id=如何使用prisma创建关联对象>如何使用prisma创建关联对象<a hidden class=anchor aria-hidden=true href=#如何使用prisma创建关联对象>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>使用create关键字</span><span style=color:#960050;background-color:#1e0010>：</span><span style=color:#a6e22e>https</span><span style=color:#f92672>:</span><span style=color:#75715e>//www.prisma.io/docs/concepts/components/prisma-schema/relations#create-a-record-and-nested-records
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>model</span> <span style=color:#a6e22e>User</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>id</span>    String <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>id</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>default</span>(<span style=color:#a6e22e>auto</span>()) <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>map</span>(<span style=color:#e6db74>&#34;_id&#34;</span>) <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>ObjectId</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>posts</span> <span style=color:#a6e22e>Post</span>[]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>model</span> <span style=color:#a6e22e>Post</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>id</span>       String <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>id</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>default</span>(<span style=color:#a6e22e>auto</span>()) <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>map</span>(<span style=color:#e6db74>&#34;_id&#34;</span>) <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>ObjectId</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>author</span>   <span style=color:#a6e22e>User</span>   <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>relation</span>(<span style=color:#a6e22e>fields</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>authorId</span>], <span style=color:#a6e22e>references</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>id</span>])
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>authorId</span> String <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>ObjectId</span> <span style=color:#75715e>// relation scalar field  (used in the `@relation` attribute above)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userAndPosts</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>create</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>posts</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>create</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>        { <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Prisma Day 2020&#39;</span> }, <span style=color:#75715e>// Populates authorId with user&#39;s id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        { <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;How to write a Prisma schema&#39;</span> }, <span style=color:#75715e>// Populates authorId with user&#39;s id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      ],
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><h4 id=prisma-disambiguating-relations>prisma Disambiguating relations<a hidden class=anchor aria-hidden=true href=#prisma-disambiguating-relations>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>在Prisma中</span><span style=color:#960050;background-color:#1e0010>，@</span><span style=color:#a6e22e>relation属性的name参数用于区分同一模型之间的多个关系</span><span style=color:#960050;background-color:#1e0010>。</span><span style=color:#a6e22e>当你在同一对模型之间定义两个关系时</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>你需要添加name参数来消除歧义</span><span style=color:#960050;background-color:#1e0010>。</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>例如</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>考虑以下模型</span><span style=color:#960050;background-color:#1e0010>：</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>model</span> <span style=color:#a6e22e>User</span> { 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>id</span> <span style=color:#a6e22e>Int</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>id</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>default</span>(<span style=color:#a6e22e>autoincrement</span>()) 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span> String<span style=color:#f92672>?</span> 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>writtenPosts</span> <span style=color:#a6e22e>Post</span>[] 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>pinnedPost</span> <span style=color:#a6e22e>Post</span><span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>model</span> <span style=color:#a6e22e>Post</span> { 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>id</span> <span style=color:#a6e22e>Int</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>id</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>default</span>(<span style=color:#a6e22e>autoincrement</span>()) 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>title</span> String<span style=color:#f92672>?</span> 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>author</span> <span style=color:#a6e22e>User</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>relation</span>(<span style=color:#a6e22e>fields</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>authorId</span>], <span style=color:#a6e22e>references</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>id</span>]) 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>authorId</span> <span style=color:#a6e22e>Int</span> 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>pinnedBy</span> <span style=color:#a6e22e>User</span><span style=color:#f92672>?</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>relation</span>(<span style=color:#a6e22e>fields</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>pinnedById</span>], <span style=color:#a6e22e>references</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>id</span>]) 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>pinnedById</span> <span style=color:#a6e22e>Int</span><span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>在这种情况下</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>关系是模糊的</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>有四种不同的方式来解释它们</span><span style=color:#960050;background-color:#1e0010>：</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>User</span>.<span style=color:#a6e22e>writtenPosts</span> <span style=color:#960050;background-color:#1e0010>↔</span> <span style=color:#a6e22e>Post</span>.<span style=color:#a6e22e>author</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>Post</span>.<span style=color:#a6e22e>authorId</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>User</span>.<span style=color:#a6e22e>writtenPosts</span> <span style=color:#960050;background-color:#1e0010>↔</span> <span style=color:#a6e22e>Post</span>.<span style=color:#a6e22e>pinnedBy</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>Post</span>.<span style=color:#a6e22e>pinnedById</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>User</span>.<span style=color:#a6e22e>pinnedPost</span> <span style=color:#960050;background-color:#1e0010>↔</span> <span style=color:#a6e22e>Post</span>.<span style=color:#a6e22e>author</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>Post</span>.<span style=color:#a6e22e>authorId</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>User</span>.<span style=color:#a6e22e>pinnedPost</span> <span style=color:#960050;background-color:#1e0010>↔</span> <span style=color:#a6e22e>Post</span>.<span style=color:#a6e22e>pinnedBy</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>Post</span>.<span style=color:#a6e22e>pinnedById</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>为了消除这些关系的歧义</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>你需要使用</span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>relation属性并提供name参数</span><span style=color:#960050;background-color:#1e0010>。</span><span style=color:#a6e22e>你可以设置任何name</span><span style=color:#960050;background-color:#1e0010>（</span><span style=color:#a6e22e>除了空字符串</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#960050;background-color:#1e0010>），</span><span style=color:#a6e22e>但它必须在关系的两边都是相同的</span><span style=color:#960050;background-color:#1e0010>：</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>model</span> <span style=color:#a6e22e>User</span> { 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>id</span> <span style=color:#a6e22e>Int</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>id</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>default</span>(<span style=color:#a6e22e>autoincrement</span>()) 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span> String<span style=color:#f92672>?</span> 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>writtenPosts</span> <span style=color:#a6e22e>Post</span>[] <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>relation</span>(<span style=color:#e6db74>&#34;WrittenPosts&#34;</span>) 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>pinnedPost</span> <span style=color:#a6e22e>Post</span><span style=color:#f92672>?</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>relation</span>(<span style=color:#e6db74>&#34;PinnedPost&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>model</span> <span style=color:#a6e22e>Post</span> { 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>id</span> <span style=color:#a6e22e>Int</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>id</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>default</span>(<span style=color:#a6e22e>autoincrement</span>()) 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>title</span> String<span style=color:#f92672>?</span> 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>author</span> <span style=color:#a6e22e>User</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>relation</span>(<span style=color:#e6db74>&#34;WrittenPosts&#34;</span>, <span style=color:#a6e22e>fields</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>authorId</span>], <span style=color:#a6e22e>references</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>id</span>]) 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>authorId</span> <span style=color:#a6e22e>Int</span> 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>pinnedBy</span> <span style=color:#a6e22e>User</span><span style=color:#f92672>?</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>relation</span>(<span style=color:#e6db74>&#34;PinnedPost&#34;</span>, <span style=color:#a6e22e>fields</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>pinnedById</span>], <span style=color:#a6e22e>references</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>id</span>]) 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>pinnedById</span> <span style=color:#a6e22e>Int</span><span style=color:#f92672>?</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>unique</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>在这个例子中</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>我们使用name参数</span><span style=color:#960050;background-color:#1e0010>（</span><span style=color:#e6db74>&#34;WrittenPosts&#34;</span><span style=color:#a6e22e>和</span><span style=color:#e6db74>&#34;PinnedPost&#34;</span><span style=color:#960050;background-color:#1e0010>）</span><span style=color:#a6e22e>来明确指定User和Post之间的两个不同关系</span><span style=color:#960050;background-color:#1e0010>。</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>更多关于</span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>relation属性的信息</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>你可以参考Prisma的官方文档</span><span style=color:#960050;background-color:#1e0010>：</span><span style=color:#a6e22e>https</span><span style=color:#f92672>:</span><span style=color:#75715e>//www.prisma.io/docs/orm/prisma-schema/data-model/relations#disambiguating-relations
</span></span></span></code></pre></div><h4 id=创建一个动态路由>创建一个动态路由<a hidden class=anchor aria-hidden=true href=#创建一个动态路由>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>https</span><span style=color:#f92672>:</span><span style=color:#75715e>//nextjs.org/docs/app/building-your-application/routing/dynamic-routes
</span></span></span><span style=display:flex><span><span style=color:#75715e>// app/blog/[slug]/page.tsx 通过[]实现动态路由
</span></span></span></code></pre></div><h4 id=next-image图片比例不一致>Next image图片比例不一致<a hidden class=anchor aria-hidden=true href=#next-image图片比例不一致>#</a></h4><pre tabindex=0><code>
https://tailwindcss.com/docs/content-configuration#dynamic-class-names
因为我写法有问题,tailwind 不兼容
    &lt;div className={cn(`h-[${height}px] w-[${width}px] overflow-hidden relative`, className)}&gt;
      &lt;NextImage fill src={src} alt={alt}&gt;&lt;/NextImage&gt;
    &lt;/div&gt;
</code></pre><h4 id=如何条件查询在prisma里面>如何条件查询在prisma里面<a hidden class=anchor aria-hidden=true href=#如何条件查询在prisma里面>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>//使用or运算符
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>server</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>update</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>serverId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>members</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>some</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>profileId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>profile</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>            <span style=color:#75715e>//方法1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>OR</span><span style=color:#f92672>:</span> [{ <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ADMIN&#39;</span> }, { <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;MODERATOR&#39;</span> }]
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 方法2,用in
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>role</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>in</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>MemberRole</span>.<span style=color:#a6e22e>ADMIN</span>, <span style=color:#a6e22e>MemberRole</span>.<span style=color:#a6e22e>MODERATOR</span>],
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>inviteCode</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>uuidV4</span>()
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    })
</span></span></code></pre></div><h4 id=重置数据库>重置数据库<a hidden class=anchor aria-hidden=true href=#重置数据库>#</a></h4><pre tabindex=0><code>npx prisma db push --force-reset
</code></pre><h4 id=路由跳转问题>路由跳转问题<a hidden class=anchor aria-hidden=true href=#路由跳转问题>#</a></h4><pre tabindex=0><code>使用redirect不起作用，遇到error，
https://stackoverflow.com/questions/76191324/next-13-4-error-next-redirect-in-api-routes
At the moment, the workaround I found is to not use:

import { redirect } from &#39;next/navigation&#39;;
But to use instead:

import { useRouter } from &#39;next/navigation&#39;
const router = useRouter()
router.push(&#34;/&#34;)
</code></pre><h4 id=next-国际化>next 国际化<a hidden class=anchor aria-hidden=true href=#next-国际化>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// 1.使用框架
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>link</span><span style=color:#f92672>:</span><span style=color:#a6e22e>https</span><span style=color:#f92672>:</span><span style=color:#75715e>//juejin.cn/post/7300460850011635766?searchId=2023122514051346A97820CD9573BB4D0F
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 搜来搜去发现自己总是在找所谓的&#34;最佳国际化方法&#34;,我的目标不是最优解，而是解决问题啊！！！
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 2.middleware 出问题了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>links</span><span style=color:#f92672>:</span><span style=color:#a6e22e>https</span><span style=color:#f92672>:</span><span style=color:#75715e>//www.youtube.com/watch?v=0i4pVrOaoiQ
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 3.sign-in和sign-up重定向报错
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>目前来说只能写死zh</span><span style=color:#f92672>/</span><span style=color:#a6e22e>sign</span><span style=color:#f92672>-</span><span style=color:#66d9ef>in</span>,<span style=color:#a6e22e>这样子太不稳妥了</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>所以我决定直接使用默认的登录配置了</span>
</span></span></code></pre></div><h4 id=next-router速度太慢了>next router速度太慢了<a hidden class=anchor aria-hidden=true href=#next-router速度太慢了>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// sources:https://stackoverflow.com/questions/65146878/nextjs-router-seems-very-slow-compare-to-react-router#:~:text=The%20issue%20arises%20because%20every,operations%20as%20much%20as%20possible.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// The issue arises because every time you use router.push, it triggers getInitialProps for the page from scratch. This can be quite expensive in terms of performance, especially if you&#39;re doing heavy calculations in your React code. To mitigate this, you might want to consider expensive operations as much as possible
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>useRouter</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;next/router&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useRouter</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>mypath</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`/dashboard/some_path`</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>mypath</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>With</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>urlOrPath</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`/dashboard/some_path`</span>;
</span></span><span style=display:flex><span>window.<span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>href</span><span style=color:#f92672>=</span> <span style=color:#a6e22e>urlOrPath</span>;
</span></span></code></pre></div><h4 id=删除server遇到问题>删除server遇到问题<a hidden class=anchor aria-hidden=true href=#删除server遇到问题>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>原因</span><span style=color:#960050;background-color:#1e0010>：</span><span style=color:#a6e22e>server与其他数据的外键作了绑定限制</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>需要在关联函数上添加删除后的动作onDelete将与之有绑定的其他数据也删除</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// links:https://github.com/prisma/prisma/discussions/10867
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>model</span> <span style=color:#a6e22e>Post</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>id</span>       <span style=color:#a6e22e>Int</span>    <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>id</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>default</span>(<span style=color:#a6e22e>autoincrement</span>())
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>title</span>    String
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>author</span>   <span style=color:#a6e22e>User</span>   <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>relation</span>(<span style=color:#a6e22e>fields</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>authorId</span>], <span style=color:#a6e22e>references</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>id</span>], <span style=color:#a6e22e>onDelete</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Cascade</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>authorId</span> <span style=color:#a6e22e>Int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>model</span> <span style=color:#a6e22e>User</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>id</span>    <span style=color:#a6e22e>Int</span>    <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>id</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>default</span>(<span style=color:#a6e22e>autoincrement</span>())
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>posts</span> <span style=color:#a6e22e>Post</span>[]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=为什么使用useeffect进行事件监听初始化要使用function-updater->为什么使用useEffect进行事件监听初始化要使用function updater ？<a hidden class=anchor aria-hidden=true href=#为什么使用useeffect进行事件监听初始化要使用function-updater->#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>open</span>, <span style=color:#a6e22e>setOpen</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>(<span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>useEffect</span>(() =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>down</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>e</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>KeyboardEvent</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>key</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;k&#39;</span> <span style=color:#f92672>&amp;&amp;</span> (<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>metaKey</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>ctrlKey</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>preventDefault</span>()
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果是这样子写的话，无依赖，那么每次执行都会只是取到open的false，因为此时存储的是一个闭包,并且open是一个快照
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>setOpen</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>open</span>) <span style=color:#75715e>//(X)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>setOpen</span>((<span style=color:#a6e22e>open</span>)=&gt;<span style=color:#f92672>!</span><span style=color:#a6e22e>open</span>)<span style=color:#75715e>//这个的话就会放到一个队列中去执行,并且参数是取的上一次的state
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    document.<span style=color:#a6e22e>addEventListener</span>(<span style=color:#e6db74>&#39;keydown&#39;</span>, <span style=color:#a6e22e>down</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> () =&gt; {
</span></span><span style=display:flex><span>      document.<span style=color:#a6e22e>removeEventListener</span>(<span style=color:#e6db74>&#39;keydown&#39;</span>, <span style=color:#a6e22e>down</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }, [])
</span></span></code></pre></div><h4 id=如何获取在组件中获取当前动态route的params>如何获取在组件中获取当前动态route的params<a hidden class=anchor aria-hidden=true href=#如何获取在组件中获取当前动态route的params>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// links:https://nextjs.org/docs/app/api-reference/functions/use-params
</span></span></span></code></pre></div><h4 id=如何在tailwind中封装一个class因为每次hover都要反复重复写一次动画太低效了>如何在tailwind中封装一个class，因为每次hover都要反复重复写一次动画，太低效了<a hidden class=anchor aria-hidden=true href=#如何在tailwind中封装一个class因为每次hover都要反复重复写一次动画太低效了>#</a></h4><pre tabindex=0><code>links:https://tailwindcss.com/docs/adding-custom-styles
@layer utilities {
  .hover-animation {
    @apply hover:bg-zinc-700/10  dark:hover:bg-zinc-700/50 transition cursor-pointer;
  }
}
</code></pre><h4 id=每次打开editmodal的时候form数据初始化为选中对象的当前数据>每次打开editModal的时候form数据初始化为选中对象的当前数据<a hidden class=anchor aria-hidden=true href=#每次打开editmodal的时候form数据初始化为选中对象的当前数据>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// 加个isOpened作为监听对象即可
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isOpened</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>isOpen</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;editServer&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>useEffect</span>(() =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>server</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>isOpened</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>form</span>.<span style=color:#a6e22e>setValue</span>(<span style=color:#e6db74>&#39;name&#39;</span>, <span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>form</span>.<span style=color:#a6e22e>setValue</span>(<span style=color:#e6db74>&#39;image&#39;</span>, <span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>image</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }, [<span style=color:#a6e22e>form</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>isOpened</span>])
</span></span></code></pre></div><h4 id=如何在nextjs中使用socketio>如何在nextjs中使用socket.io<a hidden class=anchor aria-hidden=true href=#如何在nextjs中使用socketio>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>/*参考links：
</span></span></span><span style=display:flex><span><span style=color:#75715e>https://blog.geogo.in/setting-up-socket-io-with-next-js-13-real-time-communication-in-your-web-application-8c95cf17e0c
</span></span></span><span style=display:flex><span><span style=color:#75715e>https://blog.stackademic.com/building-a-real-time-chat-app-with-next-js-socket-io-and-typescript-e60ba40c09c7
</span></span></span><span style=display:flex><span><span style=color:#75715e>实战例子：https://codesandbox.io/p/devbox/nextjs-socketio-chat-piffv?file=%2Fsrc%2Ftypes%2Fnext.ts%3A5%2C39-5%2C54 (原来还可以去这种地方找)
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//1.利用route handler来初始化服务器(目前好像2024年1.21,还不能在app router里面使用server来生成socket，https://github.com/vercel/next.js/discussions/47782,所以采用page和app并用的方法)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>/* tips:因为pages不能嵌套locale作为动态路径使用api，所以在检验url的时候，应该设为publicRoute
</span></span></span><span style=display:flex><span><span style=color:#75715e>Any file inside the folder pages/api is mapped to /api/* and will be treated as an API endpoint instead of a page. 
</span></span></span><span style=display:flex><span><span style=color:#75715e>links:https://www.answeroverflow.com/m/1163761902179074088
</span></span></span><span style=display:flex><span><span style=color:#75715e>export default authMiddleware({
</span></span></span><span style=display:flex><span><span style=color:#75715e>  beforeAuth: req =&gt; {
</span></span></span><span style=display:flex><span><span style=color:#75715e>    return intlMiddleWare(req)
</span></span></span><span style=display:flex><span><span style=color:#75715e>  },
</span></span></span><span style=display:flex><span><span style=color:#75715e>  publicRoutes: [&#39;/api/uploadthing&#39;],
</span></span></span><span style=display:flex><span><span style=color:#75715e>  ignoredRoutes: [&#39;/api/socket/(.*)&#39;]
</span></span></span><span style=display:flex><span><span style=color:#75715e>})
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>NextApiResponseServerIO</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;@/type&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>type</span> { <span style=color:#a6e22e>NextApiRequest</span>, <span style=color:#a6e22e>NextApiResponse</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;next&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Server</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>ServerIO</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;socket.io&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>api</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bodyParser</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>SocketHandler</span>(<span style=color:#a6e22e>req</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>NextApiRequest</span>, <span style=color:#a6e22e>res</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>NextApiResponseServerIO</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 初始化socket server
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>io</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>httpServer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>server</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>any</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;[ Socket Server initializing  ] &#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>io</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ServerIO</span>(<span style=color:#a6e22e>httpServer</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;/api/socketio&#39;</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>io</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>io</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>end</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>//2.写一个provider将socket-client在客户端全局提供
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 参考links:https://medium.com/@steveleung9527/react-contextapi-socket-io-setup-typescript-174acda1164
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#e6db74>&#39;use client&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>React</span>, { <span style=color:#a6e22e>createContext</span>, <span style=color:#a6e22e>useContext</span>, <span style=color:#a6e22e>useEffect</span>, <span style=color:#a6e22e>useState</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;react&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>io</span>, <span style=color:#a6e22e>Socket</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;socket.io-client&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>SocketContextState</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>socket</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Socket</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>isConnected</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>boolean</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>SocketContext</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createContext</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>SocketContextState</span><span style=color:#f92672>&gt;</span>({} <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>SocketContextState</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>SocketProvider</span> <span style=color:#f92672>=</span> ({ <span style=color:#a6e22e>children</span> }<span style=color:#f92672>:</span> { <span style=color:#a6e22e>children</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>React</span>.<span style=color:#a6e22e>ReactNode</span> }) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>socket</span>, <span style=color:#a6e22e>setSocket</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Socket</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>&gt;</span>(<span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>isConnected</span>, <span style=color:#a6e22e>setIsConnected</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>(<span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>useEffect</span>(() =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>socket</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>io</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>NEXT_PUBLIC_SITE</span><span style=color:#f92672>!</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;/api/socketio&#39;</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;connect&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;[SOCKET CONNECTED] &gt;&#39;</span>, <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>setIsConnected</span>(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>setSocket</span>(<span style=color:#a6e22e>socket</span>)
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>socket</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> () =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>disconnect</span>()
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }, [])
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>SocketContext</span>.<span style=color:#a6e22e>Provider</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span>{{ <span style=color:#a6e22e>socket</span>, <span style=color:#a6e22e>isConnected</span> }}<span style=color:#f92672>&gt;</span>{<span style=color:#a6e22e>children</span>}<span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/SocketContext.Provider&gt;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>SocketProvider</span>
</span></span></code></pre></div><h4 id=shadcn-popover溢出到视图外面去了>shadcn-popover溢出到视图外面去了<a hidden class=anchor aria-hidden=true href=#shadcn-popover溢出到视图外面去了>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// issues:https://github.com/radix-ui/primitives/issues/557
</span></span></span><span style=display:flex><span><span style=color:#75715e>// avoidCollisions,collisionBoundary,collisionPadding好像是跟这几个属性相关，但我不是很想看。。。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 目前只能调整一下方向来展示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>PopoverContent</span> <span style=color:#a6e22e>side</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;left&#39;</span>  <span style=color:#a6e22e>className</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;p-0&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Picker</span> <span style=color:#a6e22e>data</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>data</span>} <span style=color:#a6e22e>onEmojiSelect</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>onChange</span>} <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/PopoverContent&gt;</span>
</span></span></code></pre></div><h4 id=在输入框中按回车同时打开了附件栏>在输入框中按回车同时打开了附件栏<a hidden class=anchor aria-hidden=true href=#在输入框中按回车同时打开了附件栏>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// 因为form中的button在类型没设置的情况下按下回车后会自动触发onSubmit,然后触发按钮的onClick，解决方法就是type设置为button
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Button</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;button&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>onClick</span><span style=color:#f92672>=</span>{() =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>onOpen</span>(<span style=color:#e6db74>&#39;fileAttachment&#39;</span>, { <span style=color:#a6e22e>apiUrl</span>, <span style=color:#a6e22e>query</span> })
</span></span><span style=display:flex><span>  }}
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>variant</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ghost&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>size</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;icon&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>className</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;p-1 w-7 h-7 border-transparent rounded-full text-sm bg-zinc-500 hover:bg-zinc-600 dark:hover:bg-zinc-200 hover:text-white dark:bg-zinc-400 text-white dark:text-[#313338]&#34;</span> <span style=color:#f92672>&gt;</span>
</span></span></code></pre></div><h4 id=next-i18n-插值翻译>next i18n 插值翻译<a hidden class=anchor aria-hidden=true href=#next-i18n-插值翻译>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>links</span><span style=color:#f92672>:</span><span style=color:#a6e22e>https</span><span style=color:#f92672>:</span><span style=color:#75715e>//www.i18next.com/translation-function/interpolation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>{
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;key&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;{{what}} is {{how}}&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>i18next</span>.<span style=color:#a6e22e>t</span>(<span style=color:#e6db74>&#39;key&#39;</span>, { <span style=color:#a6e22e>what</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;i18next&#39;</span>, <span style=color:#a6e22e>how</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;great&#39;</span> });
</span></span><span style=display:flex><span><span style=color:#75715e>// -&gt; &#34;i18next is great&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>// -&gt; &#34;I am Jan&#34;
</span></span></span></code></pre></div><h4 id=prisma-分页查询-cursor-based-pagination>prisma 分页查询 (Cursor-based Pagination)<a hidden class=anchor aria-hidden=true href=#prisma-分页查询-cursor-based-pagination>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>//links:https://www.prisma.io/docs/orm/prisma-client/queries/pagination#cursor-based-pagination
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>firstQueryResults</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>post</span>.<span style=color:#a6e22e>findMany</span>({
</span></span><span style=display:flex><span> <span style=color:#a6e22e>take</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>4</span>,
</span></span><span style=display:flex><span> <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>contains</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Prisma&#39;</span> } },
</span></span><span style=display:flex><span> <span style=color:#a6e22e>orderBy</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;asc&#39;</span> },
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Bookmark your location in the result set - in this case, the ID of the last post in the list of 4.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>lastPostInResults</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>firstQueryResults</span>[<span style=color:#ae81ff>3</span>]; <span style=color:#75715e>// Remember: zero-based index! :)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>myCursor</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>lastPostInResults</span>.<span style=color:#a6e22e>id</span>; <span style=color:#75715e>// Example: 29
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>secondQueryResults</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>post</span>.<span style=color:#a6e22e>findMany</span>({
</span></span><span style=display:flex><span> <span style=color:#a6e22e>take</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>4</span>,
</span></span><span style=display:flex><span> <span style=color:#a6e22e>skip</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span>, <span style=color:#75715e>// Skip the cursor
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>cursor</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>myCursor</span> },
</span></span><span style=display:flex><span> <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>contains</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Prisma&#39;</span> } },
</span></span><span style=display:flex><span> <span style=color:#a6e22e>orderBy</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;asc&#39;</span> },
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>lastPostInResults</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>secondQueryResults</span>[<span style=color:#ae81ff>3</span>]; <span style=color:#75715e>// Remember: zero-based index! :)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>myCursor</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>lastPostInResults</span>.<span style=color:#a6e22e>id</span>; <span style=color:#75715e>// Example: 52
</span></span></span></code></pre></div><h4 id=prisma-如何实现hasnextpage>prisma 如何实现hasNextPage?<a hidden class=anchor aria-hidden=true href=#prisma-如何实现hasnextpage>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// Fetch PAGE_BATCH + 1 messages
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>messages</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>channelMessage</span>.<span style=color:#a6e22e>findMany</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>take</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>PAGE_BATCH</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>channelId</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>include</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>member</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>include</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Profile</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>orderBy</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createdAt</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;desc&#39;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>hasNextPage</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>nextCursor</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// If we got an extra message, there&#39;s a next page
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>messages</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>PAGE_BATCH</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>hasNextPage</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>messages</span>.<span style=color:#a6e22e>pop</span>(); <span style=color:#75715e>// Remove the extra message
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// If there&#39;s a next page, set the nextCursor to the ID of the last message
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>hasNextPage</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>nextCursor</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>messages</span>[<span style=color:#a6e22e>messages</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// 土方法
</span></span></span></code></pre></div><h4 id=tanstack-query是啥>tanstack-query是啥?<a hidden class=anchor aria-hidden=true href=#tanstack-query是啥>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// 1.一种封装好的请求工具，将异步请求函数放进去执行，会对该请求添加一个key用于缓存，当再次请求带有相同key的函数时，会直接拿现有的缓存，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 2.并且调用请求后会返回当前状态等一系列数据信息(实时更新),
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 3.可以实现条件执行，当满足某种条件后再去fetch data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>statusUser</span>, <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span><span style=color:#a6e22e>user</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>useQuery</span>(
</span></span><span style=display:flex><span><span style=color:#a6e22e>enabled</span><span style=color:#f92672>:</span><span style=color:#a6e22e>post</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>userId</span><span style=color:#f92672>!=</span><span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span><span style=color:#a6e22e>queryKey</span><span style=color:#f92672>:</span>[<span style=color:#e6db74>&#34;users&#34;</span>,<span style=color:#a6e22e>post</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span><span style=color:#a6e22e>queryFn</span><span style=color:#f92672>:</span>()=&gt;<span style=color:#a6e22e>getUser</span>(<span style=color:#a6e22e>post</span><span style=color:#f92672>!</span>.<span style=color:#a6e22e>userId</span>))
</span></span><span style=display:flex><span><span style=color:#75715e>// 4.能够进行修改数据的同时，减少请求的次数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> {<span style=color:#a6e22e>status</span>,<span style=color:#a6e22e>error</span>,<span style=color:#a6e22e>mutate</span>}<span style=color:#f92672>=</span><span style=color:#a6e22e>useMutation</span>(
</span></span><span style=display:flex><span>{ 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mutationFn</span><span style=color:#960050;background-color:#1e0010>：</span><span style=color:#a6e22e>createPost</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>onSuccess</span><span style=color:#960050;background-color:#1e0010>：</span><span style=color:#a6e22e>newPost</span>=&gt;{
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 无需再次请求，直接设置好
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>queryclient</span>.<span style=color:#a6e22e>setQueryData</span>([<span style=color:#e6db74>&#34;posts&#34;</span>,<span style=color:#a6e22e>newPost</span>.<span style=color:#a6e22e>id</span>],<span style=color:#a6e22e>newPost</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>navigate</span>(<span style=color:#960050;background-color:#1e0010>/posts/s(newPost.id))</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span><span style=color:#75715e>// 5.能够快速进行分页请求以及滚动无限加载
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>fetchNextPage</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>fetchPreviousPage</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>hasNextPage</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>hasPreviousPage</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>isFetchingNextPage</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>isFetchingPreviousPage</span>,
</span></span><span style=display:flex><span>  ...<span style=color:#a6e22e>result</span>
</span></span><span style=display:flex><span>} <span style=color:#f92672>=</span> <span style=color:#a6e22e>useInfiniteQuery</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>queryKey</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>queryFn</span><span style=color:#f92672>:</span> ({ <span style=color:#a6e22e>pageParam</span> }) =&gt; <span style=color:#a6e22e>fetchPage</span>(<span style=color:#a6e22e>pageParam</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>initialPageParam</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>  ...<span style=color:#a6e22e>options</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getNextPageParam</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>lastPage</span>, <span style=color:#a6e22e>allPages</span>, <span style=color:#a6e22e>lastPageParam</span>, <span style=color:#a6e22e>allPageParams</span>) =&gt;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastPage</span>.<span style=color:#a6e22e>nextCursor</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getPreviousPageParam</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>firstPage</span>, <span style=color:#a6e22e>allPages</span>, <span style=color:#a6e22e>firstPageParam</span>, <span style=color:#a6e22e>allPageParams</span>) =&gt;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>firstPage</span>.<span style=color:#a6e22e>prevCursor</span>,
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span><span style=color:#75715e>//https://tanstack.com/query/latest/docs/framework/react/examples/load-more-infinite-scroll
</span></span></span></code></pre></div><h4 id=date-fns如何国际化>date-fns如何国际化<a hidden class=anchor aria-hidden=true href=#date-fns如何国际化>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>format</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;date-fns&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>zhCN</span>, <span style=color:#a6e22e>enUS</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;date-fns/locale&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>getI18n</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;react-i18next&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>locales</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>zh</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>zhCN</span>, <span style=color:#a6e22e>en</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>enUS</span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>dateFormat</span>(<span style=color:#a6e22e>date</span><span style=color:#f92672>:</span> Date, <span style=color:#a6e22e>formatStr</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;PPpp&#39;</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>language</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>getI18n</span>()
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>format</span>(<span style=color:#a6e22e>date</span>, <span style=color:#a6e22e>formatStr</span>, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>locale</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>locales</span>[<span style=color:#a6e22e>language</span> <span style=color:#a6e22e>as</span> <span style=color:#e6db74>&#39;zh&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;en&#39;</span>]
</span></span><span style=display:flex><span> })
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>//参考格式:https://date-fns.org/v3.3.1/docs/format
</span></span></span></code></pre></div><h4 id=nextimage-加载不出来>nextImage 加载不出来<a hidden class=anchor aria-hidden=true href=#nextimage-加载不出来>#</a></h4><pre tabindex=0><code>links:https://cloud.tencent.com/developer/ask/sof/106766303
又好了，我也不知道啥原因，目前无法复现。
</code></pre><h4 id=如何使用react-query配合socket更新已请求的缓存数据>如何使用react-query配合socket更新已请求的缓存数据<a hidden class=anchor aria-hidden=true href=#如何使用react-query配合socket更新已请求的缓存数据>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>links</span><span style=color:#f92672>:</span><span style=color:#a6e22e>https</span><span style=color:#f92672>:</span><span style=color:#75715e>//tkdodo.eu/blog/using-web-sockets-with-react-query
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>queryClient</span>.<span style=color:#a6e22e>setQueryData</span>([<span style=color:#a6e22e>queryKey</span>], (<span style=color:#a6e22e>oldData</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>any</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 需要返回一个immutable的对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>newPages</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>oldData</span>.<span style=color:#a6e22e>pages</span>.<span style=color:#a6e22e>slice</span>()
</span></span><span style=display:flex><span><span style=color:#75715e>// Immutability , Updates via setQueryData must be performed in an immutable way. DO NOT attempt to write directly to the cache by mutating oldData or data that you retrieved via getQueryData in place.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>newPages</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          ...<span style=color:#a6e22e>newPages</span>[<span style=color:#ae81ff>0</span>],
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>items</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>message</span>, ...<span style=color:#a6e22e>newPages</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>items</span>]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>newData</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          ...<span style=color:#a6e22e>oldData</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>pages</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>newPages</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>newData</span>
</span></span><span style=display:flex><span>      })
</span></span></code></pre></div><h4 id=如何使用ref并且将在type里面定义ref属性>如何使用ref，并且将在type里面定义ref属性<a hidden class=anchor aria-hidden=true href=#如何使用ref并且将在type里面定义ref属性>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>links</span><span style=color:#f92672>:</span><span style=color:#a6e22e>https</span><span style=color:#f92672>:</span><span style=color:#75715e>//stackoverflow.com/questions/33796267/how-to-use-refs-in-react-with-typescript
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>type</span>  <span style=color:#a6e22e>stepInput</span><span style=color:#f92672>=</span> <span style=color:#a6e22e>React</span>.<span style=color:#a6e22e>RefObject</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>HTMLInputElement</span><span style=color:#f92672>&gt;</span>;
</span></span></code></pre></div><h4 id=如何在ts里写一个throttle>如何在ts里写一个throttle<a hidden class=anchor aria-hidden=true href=#如何在ts里写一个throttle>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>//links:https://vue3js.cn/interview/JavaScript/debounce_throttle.html#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>throttle</span>(<span style=color:#a6e22e>fn</span><span style=color:#f92672>:</span> Function, <span style=color:#a6e22e>delay</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>number</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>timer</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>ReturnType</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>setTimeout</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>startTime</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>()
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>function</span> (...<span style=color:#a6e22e>args</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>any</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>curTime</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>remaining</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>delay</span> <span style=color:#f92672>-</span> (<span style=color:#a6e22e>curTime</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>startTime</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 说明超过delay了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>remaining</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>fn</span>(...<span style=color:#a6e22e>args</span>)
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>startTime</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>()
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>clearTimeout</span>(<span style=color:#a6e22e>timer</span>)
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>timer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>setTimeout</span>(() =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fn</span>(...<span style=color:#a6e22e>args</span>)
</span></span><span style=display:flex><span>      }, <span style=color:#a6e22e>remaining</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=nextjs--url-query参数>nextjs url query参数<a hidden class=anchor aria-hidden=true href=#nextjs--url-query参数>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>page</span> <span style=color:#a6e22e>links</span><span style=color:#f92672>:</span><span style=color:#a6e22e>https</span><span style=color:#f92672>:</span><span style=color:#75715e>//nextjs.org/docs/app/api-reference/file-conventions/page#searchparams-optional
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>component</span> <span style=color:#a6e22e>links</span><span style=color:#f92672>:</span><span style=color:#a6e22e>https</span><span style=color:#f92672>:</span><span style=color:#75715e>//www.codingbeautydev.com/blog/nextjs-get-url-query-params
</span></span></span></code></pre></div><h4 id=部署问题>部署问题<a hidden class=anchor aria-hidden=true href=#部署问题>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// 阿里云npm i killed 内存不够了，使用虚拟内存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>links</span><span style=color:#f92672>:</span><span style=color:#a6e22e>https</span><span style=color:#f92672>:</span><span style=color:#75715e>//cloud.tencent.com/developer/article/1750413
</span></span></span><span style=display:flex><span><span style=color:#75715e>// node 内存崩溃
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>links</span><span style=color:#f92672>:</span><span style=color:#a6e22e>https</span><span style=color:#f92672>:</span><span style=color:#75715e>//www.jianshu.com/p/a0a0b57a375c
</span></span></span><span style=display:flex><span><span style=color:#75715e>// https 才能访问camera
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>参考视频</span><span style=color:#f92672>:</span><span style=color:#a6e22e>https</span><span style=color:#f92672>:</span><span style=color:#75715e>//www.youtube.com/watch?v=qlcVx-k-02E   https://notthebe.ee/blog/easy-ssl-in-homelab-dns01/
</span></span></span></code></pre></div></div><div><div class=breadcrumbs><div><span style=opacity:.5>></span>
<a style="border-bottom:1px solid rgba(125,125,125,.3);transition:border .3s ease-in-out;opacity:.5" href=/posts>cd &nbsp; .&nbsp;.</a></div></div></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://dmaziyo.github.io/posts/learn-effectively-from-program-tutorial/><span class=title>« Prev</span><br><span>如何从一个视频教程中去学习</span></a>
<a class=next href=https://dmaziyo.github.io/posts/elements-plus-issue-14738/><span class=title>Next »</span><br><span>[github-issues]element-plus menu组件隐藏功能</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://dmaziyo.github.io>MaZiYo's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>